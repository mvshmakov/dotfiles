#!/usr/bin/env sh
# This script opts out Spotlight from indexing node_modules directories.
# Inspired by https://github.com/Strajk/setup and
# https://mattprice.me/2020/programmatically-modify-spotlight-ignore/

set -eu

DIR="${ROOT_DIR:-/Users/$USER/projects}"
PLIST="/System/Volumes/Data/.Spotlight-V100/VolumeConfiguration.plist"
PLIST_BUDDY_BIN="/usr/libexec/PlistBuddy"

get_exclusions() {
  sudo "$PLIST_BUDDY_BIN" -c 'Print :Exclusions' "$PLIST" \
    | sed -e 1d -e '$d' -e 's/^[\t ]*//'
}

find_candidates() {
  find "$DIR" -type d -name node_modules -prune
}

add_missing() {
  candidates="$(find_candidates)"
  existing="$(get_exclusions)"

  printf '%s\n' "$candidates" | while IFS= read -r path; do
    if ! printf '%s\n' "$existing" | grep -Fxq "$path"; then
      sudo "$PLIST_BUDDY_BIN" -c "Add :Exclusions: string $path" "$PLIST"
    fi
  done

  sudo launchctl stop com.apple.metadata.mds
  sudo launchctl start com.apple.metadata.mds

  printf 'Current content of Exclusions:\n'
  get_exclusions
  printf '\n\xF0\x9F\x91\x80 Check and verify at System Settings > Siri & Spotlight > Spotlight Privacy\n'
}

usage() {
  cat <<USAGE
Usage: $(basename "$0") [command]
Commands:
  add     Find node_modules directories and add them to Spotlight exclusions (default)
  show    Show current Spotlight exclusions
  find    Print candidate node_modules directories
USAGE
}

cmd="${1:-add}"
case "$cmd" in
  add)
    add_missing
    ;;
  show)
    get_exclusions
    ;;
  find)
    find_candidates
    ;;
  *)
    usage
    exit 1
    ;;
esac
